import jsPDF from 'jspdf';
import autoTable from 'jspdf-autotable';
import { Proposal, Lead, ProposalOption } from '../types';

export const generateProposalPDF = (proposal: Proposal, lead: Lead) => {
    const doc = new jsPDF();
    const pageWidth = doc.internal.pageSize.width;

    // --- Header ---
    doc.setFillColor(88, 28, 135); // Purple-900 (approx)
    doc.rect(0, 0, pageWidth, 40, 'F');

    doc.setTextColor(255, 255, 255);
    doc.setFontSize(24);
    doc.setFont("helvetica", "bold");
    doc.text("SHRAVYA TOURS", 15, 25);

    doc.setFontSize(10);
    doc.setFont("helvetica", "normal");
    doc.text("Making Dreams Come True", 15, 32);

    doc.text("Proposal", pageWidth - 15, 20, { align: 'right' });
    doc.setFontSize(12);
    doc.text(`#${proposal.id}`, pageWidth - 15, 28, { align: 'right' });

    // --- Customer Info ---
    doc.setTextColor(0, 0, 0);
    doc.setFontSize(10);
    let yPos = 55;

    doc.setFont("helvetica", "bold");
    doc.text("Prepared For:", 15, yPos);
    doc.setFont("helvetica", "normal");
    doc.text(lead.name, 15, yPos + 5);
    doc.text(lead.email || '', 15, yPos + 10);
    doc.text(lead.phone || '', 15, yPos + 15);

    doc.setFont("helvetica", "bold");
    doc.text("Destination:", pageWidth / 2, yPos);
    doc.setFont("helvetica", "normal");
    doc.text(lead.destination || 'Custom', pageWidth / 2, yPos + 5);

    doc.setFont("helvetica", "bold");
    doc.text("Valid Date:", pageWidth - 50, yPos);
    doc.setFont("helvetica", "normal");
    const validUntil = proposal.validUntil ? new Date(proposal.validUntil).toLocaleDateString() : '7 Days from issue';
    doc.text(validUntil, pageWidth - 50, yPos + 5);

    yPos += 30;

    // --- Proposal Title ---
    doc.setFontSize(16);
    doc.setFont("helvetica", "bold");
    doc.text(proposal.title, 15, yPos);
    yPos += 5;

    // --- Options ---
    proposal.options.forEach((option, index) => {
        if (yPos > 250) {
            doc.addPage();
            yPos = 20;
        }

        yPos += 15;

        // Option Header
        doc.setFillColor(243, 244, 246); // Gray-100
        doc.roundedRect(15, yPos, pageWidth - 30, 20, 3, 3, 'F');

        doc.setFontSize(12);
        doc.setFont("helvetica", "bold");
        doc.setTextColor(88, 28, 135); // Purple
        doc.text(option.name, 20, yPos + 13);

        doc.setTextColor(0, 0, 0);
        doc.text(`₹${option.price.toLocaleString()}`, pageWidth - 25, yPos + 13, { align: 'right' });

        yPos += 25;

        // Inclusions
        doc.setFontSize(10);
        doc.setTextColor(100, 100, 100);

        const inclusions = [
            ...option.inclusions,
            `Hotels: ${option.hotels.length > 0 ? option.hotels.join(', ') : 'As per selection'}`
        ];

        // Using autoTable for cleaner list
        autoTable(doc, {
            startY: yPos,
            margin: { left: 20 },
            body: inclusions.map(inc => [`• ${inc}`]),
            theme: 'plain',
            styles: { fontSize: 10, cellPadding: 1 },
            columnStyles: { 0: { cellWidth: 150 } },
        });

        // @ts-ignore
        yPos = doc.lastAutoTable.finalY + 5;
    });

    // --- Footer ---
    const pageCount = doc.getNumberOfPages();
    for (let i = 1; i <= pageCount; i++) {
        doc.setPage(i);
        doc.setFontSize(8);
        doc.setTextColor(150, 150, 150);
        doc.text(`Page ${i} of ${pageCount}`, pageWidth / 2, doc.internal.pageSize.height - 10, { align: 'center' });
        doc.text(`Generated by Shravya Tours`, 15, doc.internal.pageSize.height - 10);
    }

    doc.save(`Quotation_${lead.name.replace(/\s+/g, '_')}_${proposal.id}.pdf`);
};

export const generateProformaInvoice = (proposal: Proposal, optionId: string, lead: Lead) => {
    const doc = new jsPDF();
    const pageWidth = doc.internal.pageSize.width;
    const option = proposal.options.find(o => o.id === optionId);

    if (!option) return;

    // --- Mock Company Data ---
    const company = {
        name: "SHRAVYA TOURS",
        address: "A508, Wisteria, Patil Nagar, Chikhali, PCMC, Pune, Maharashtra - 411062",
        phone: "+91 80109 55675",
        email: "toursshravya@gmail.com",
        gstin: "02ABCDE1234F1Z5", // Himachal Pradesh Code 02
        bank: {
            name: "HDFC Bank",
            accountName: "Shravya Tours & Travels",
            accountNo: "50200012345678",
            ifsc: "HDFC0001234",
            branch: "Manali Main"
        }
    };

    // --- Calculations (Assuming 5% GST Inclusive) ---
    const gstRate = 5;
    const totalPrice = option.price;
    const taxableValue = totalPrice / (1 + gstRate / 100);
    const gstAmount = totalPrice - taxableValue;
    const cgst = gstAmount / 2;
    const sgst = gstAmount / 2;

    // --- Header ---
    doc.setFontSize(20);
    doc.setFont("helvetica", "bold");
    doc.text("PROFORMA INVOICE", pageWidth - 15, 20, { align: 'right' });

    doc.setFontSize(10);
    doc.setFont("helvetica", "normal");
    doc.text(`Date: ${new Date().toLocaleDateString()}`, pageWidth - 15, 30, { align: 'right' });
    doc.text(`Ref No: PI-${proposal.id.slice(-6).toUpperCase()}`, pageWidth - 15, 35, { align: 'right' });

    // Company Info
    doc.setFontSize(14);
    doc.setFont("helvetica", "bold");
    doc.text(company.name, 15, 20);
    doc.setFontSize(9);
    doc.setFont("helvetica", "normal");
    doc.text(company.address, 15, 26);
    doc.text(`Phone: ${company.phone}`, 15, 31);
    doc.text(`Email: ${company.email}`, 15, 36);
    doc.text(`GSTIN: ${company.gstin}`, 15, 41);

    // Bill To
    doc.line(15, 45, pageWidth - 15, 45);
    doc.setFont("helvetica", "bold");
    doc.text("Bill To:", 15, 52);
    doc.setFont("helvetica", "normal");
    doc.text(lead.name, 15, 58);
    if (lead.email) doc.text(lead.email, 15, 63);
    if (lead.phone) doc.text(lead.phone, 15, 68);
    doc.text(`Place of Supply: ${lead.location || 'State Code 00'}`, 15, 73); // Should ideally be dynamic

    // --- Table ---
    autoTable(doc, {
        startY: 80,
        head: [['S.No', 'Description', 'HSN/SAC', 'Taxable Val', 'CGST (2.5%)', 'SGST (2.5%)', 'Total']],
        body: [[
            '1',
            `Tour Package: ${proposal.title} - ${option.name}`,
            '9985', // Tour Operator Service
            taxableValue.toFixed(2),
            cgst.toFixed(2),
            sgst.toFixed(2),
            totalPrice.toLocaleString('en-IN')
        ]],
        foot: [[
            '', 'Total', '', taxableValue.toFixed(2), cgst.toFixed(2), sgst.toFixed(2), `INR ${totalPrice.toLocaleString('en-IN')}`
        ]],
        theme: 'grid',
        headStyles: { fillColor: [88, 28, 135], textColor: 255 },
        footStyles: { fillColor: [243, 244, 246], textColor: 0, fontStyle: 'bold' }
    });

    // --- Bank Details ---
    // @ts-ignore
    let yPos = doc.lastAutoTable.finalY + 15;

    doc.setFontSize(10);
    doc.setFont("helvetica", "bold");
    doc.text("Bank Details for Payment:", 15, yPos);

    doc.setFont("helvetica", "normal");
    doc.setFontSize(9);
    yPos += 6;
    doc.text(`Account Name: ${company.bank.accountName}`, 15, yPos);
    doc.text(`Bank Name: ${company.bank.name}`, 15, yPos + 5);
    doc.text(`Account Number: ${company.bank.accountNo}`, 15, yPos + 10);
    doc.text(`IFSC Code: ${company.bank.ifsc}`, 15, yPos + 15);
    doc.text(`Branch: ${company.bank.branch}`, 15, yPos + 20);

    // --- Terms ---
    yPos += 35;
    doc.setFont("helvetica", "bold");
    doc.text("Terms & Conditions:", 15, yPos);
    doc.setFont("helvetica", "normal");
    doc.setFontSize(8);
    doc.text("1. This is a computer generated invoice.", 15, yPos + 6);
    doc.text("2. Please quote the reference number in all communications.", 15, yPos + 10);
    doc.text("3. Payment to be made 100% in advance for confirmation.", 15, yPos + 14);

    doc.save(`Proforma_${lead.name.replace(/\s+/g, '_')}_${proposal.id}.pdf`);
};
